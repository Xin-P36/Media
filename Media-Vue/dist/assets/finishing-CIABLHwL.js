import{r as p,D as W,o as me,c as I,b as C,q as U,e as n,u as v,i as ge,f as i,h as _,F as S,y as F,G as Z,H as he,t as $,n as Ie,m as _e,I as ye,p as b,k as E,E as g,J as Ce,j as d,K as ee,L as le,z as te}from"./index-DrTqUjeq.js";import{g as be}from"./toolCategory-NaEACP6i.js";import{_ as ke,r as j}from"./_plugin-vue_export-helper-DzaqoFoA.js";const Ve={id:"menuList"},Ue={key:0,class:"menu-grid"},xe=["onClick","onMouseenter"],Pe=["src"],we={key:1},Me={class:"submenu-header"},Ne={class:"submenu-title"},Te={key:0,class:"parent-menu-title"},$e={class:"menu-grid"},Ee=["onClick","onMouseenter"],Ae=["src"],De={class:"dialog-footer"},Se={class:"main-buttons"},Be={__name:"finishing",setup(qe){let x=p([]),k=p("main");p(null);let c=p([]);const z=ge(),N=p(!1),P=p(!1),T=p(),l=p({toolId:"",toolName:"",path:"",description:"",sort:90,parentId:"",coverImageUrl:null}),f=p(!1),y=p({isSubCategory:!1,parentPath:"",parentId:""}),m=p(null),ae=t=>{const e=[t],r=s=>{s&&Array.isArray(s)&&s.forEach(u=>{e.push(u.toolId),u.lists&&u.lists.length>0&&r(u.lists)})},o=s=>{if(s&&Array.isArray(s))for(const u of s){if(u.toolId===t){r(u.lists);return}u.lists&&u.lists.length>0&&o(u.lists)}};return o(x.value),e},oe=W(()=>{const t=[],e=r=>{r&&Array.isArray(r)&&r.forEach(o=>{t.push({value:o.toolId,label:`${o.name} (${o.path})`,path:o.path}),o.lists&&o.lists.length>0&&e(o.lists)})};if(e(x.value),f.value&&l.value.toolId){const r=ae(l.value.toolId);return t.filter(o=>!r.includes(o.value))}return t}),ne={toolName:[{required:!0,message:"请输入分类名称",trigger:"blur"},{min:1,max:20,message:"长度在 1 到 20 个字符",trigger:"blur"}],path:[{required:!0,message:"请输入分类路径",trigger:"blur"}]},A=()=>{N.value=!1,l.value={toolName:"",path:"",description:"",sort:90,parentId:"",coverImageUrl:null},T.value&&T.value.resetFields()},re=t=>{if(t){const e=o=>{if(o&&Array.isArray(o))for(const s of o){if(s.toolId===t)return s;if(s.lists&&s.lists.length>0){const u=e(s.lists);if(u)return u}}return null},r=e(x.value);if(r)if(f.value){const o=l.value.path.split("/"),s=o[o.length-1]||o[o.length-2]||"";l.value.path=r.path+"/"+s}else l.value.path=r.path+"/"}else f.value||(l.value.path="/")},G=(t=!1,e=null)=>{f.value=!1,y.value.isSubCategory=t,t&&e?(y.value.parentPath=e.path,y.value.parentId=e.toolId,l.value.path=e.path+"/",l.value.parentId=e.toolId):(y.value.parentPath="",y.value.parentId="",l.value.path="/",l.value.parentId=""),l.value.toolId="",l.value.toolName="",l.value.description="",l.value.sort=90,l.value.coverImageUrl=null,N.value=!0},H=t=>{f.value=!0,l.value.toolId=t.toolId,l.value.toolName=t.name,l.value.description=t.description||"",l.value.sort=t.sort||90,l.value.parentId=t.parentId||"",l.value.coverImageUrl=t.coverImageUrl||null;const e=t.path.split("/"),r=e[e.length-1]||e[e.length-2]||"";let o="";if(t.parentId){const s=x.value.find(u=>u.toolId===t.parentId);s&&(o=s.path)}l.value.path=o&&r?o+"/"+r:t.path,y.value.isSubCategory=!1,N.value=!0,m.value=t},se=async()=>{T.value&&await T.value.validate(async t=>{if(t){P.value=!0;try{if(f.value&&m.value&&(!m.value.parentId||m.value.parentId==="")){const o=l.value.path!==m.value.path,s=l.value.toolName!==m.value.name,u=l.value.description!==(m.value.description||""),h=l.value.sort!==(m.value.sort||90);if(o&&(s||u||h)){g.warning("根路径与常规信息不能同时修改"),P.value=!1;return}}const e={toolId:l.value.toolId,toolName:l.value.toolName,path:l.value.path,description:l.value.description||"",sort:l.value.sort,parentId:l.value.parentId,coverImageUrl:l.value.coverImageUrl};f.value&&m.value&&(!m.value.parentId||m.value.parentId==="")&&(l.value.path!==m.value.path?e.parentId="":e.parentId=0);let r;f.value?(r=await j({url:"/tool/update",method:"PUT",data:e}),r.code===200?g.success("分类更新成功"):g.error(r.message||"更新分类失败")):(r=await j({url:"/tool/create",method:"POST",data:e}),r.code===200?g.success("分类创建成功"):g.error(r.message||"创建分类失败")),r.code===200&&(A(),await q())}catch(e){g.error(f.value?"更新分类时发生错误":"创建分类时发生错误"),console.error(f.value?"更新分类时发生错误:":"创建分类时发生错误:",e)}finally{P.value=!1}}})},ue=async()=>{const t=m.value;if(!t){g.error("未找到要删除的分类");return}try{let e=5,r=`确定 (${e}s)`;const o=Ce.confirm(`确定要删除分类 "${t.name}" 吗？此操作不可恢复！`,"删除确认",{type:"warning",showCancelButton:!0,confirmButtonText:r,cancelButtonText:"取消",closeOnClickModal:!1,closeOnPressEscape:!1,lockScroll:!0,distinguishCancelAndClose:!0,beforeClose:(h,Q,D)=>{if(h==="confirm"){if(e>0){g.warning(`请等待 ${e} 秒后确认删除`);return}D()}else D()}}).then(()=>Promise.resolve()).catch(h=>Promise.reject(h)),s=setInterval(()=>{if(e--,e>=0){r=`确定 (${e}s)`;const h=document.querySelector(".el-message-box__btns .el-button--primary");h&&(h.textContent=r,e>0?h.disabled=!0:h.disabled=!1)}e<=0&&clearInterval(s)},1e3);await o;const u=await j({url:`/tool/delete/${t.toolId}`,method:"DELETE"});u.code===200?(g.success("分类删除成功"),A(),await q()):g.error(u.message||"删除分类失败")}catch(e){e!=="cancel"&&e!=="close"&&(g.error("删除分类时发生错误"),console.error("删除分类时发生错误:",e))}};let w=p(null),M=p(null),B=p({x:0,y:0});const ie=W(()=>({left:`${B.value.x+10}px`,top:`${B.value.y+10}px`})),J=t=>!t||!Array.isArray(t)?[]:t.map(e=>({toolId:e.toolId,name:e.toolName,coverImageUrl:e.coverImageUrl,path:e.path,description:e.description,sort:e.sort,parentId:e.parentId,lists:e.children?J(e.children):null})),q=async()=>{try{const t=await be();t.code===200?x.value=J(t.data):(g.error("获取分类数据失败: "+t.message),console.error("获取分类数据失败:",t.message))}catch(t){g.error("获取分类数据时发生错误，请检查网络连接"),console.error("获取分类数据时发生错误:",t)}},K=t=>{t.lists&&t.lists.length>0?(k.value==="main"?c.value=[t]:c.value=[...c.value,t],k.value="sub"):z.push({name:"classificationdisplay",query:{id:t.toolId}})},de=()=>{c.value.length>1?c.value=c.value.slice(0,-1):(k.value="main",c.value=[])},X=()=>k.value==="main"?x.value:k.value==="sub"&&c.value.length>0?c.value[c.value.length-1].lists||[]:[],ce=()=>c.value.length>0?c.value[c.value.length-1].name:"",Y=()=>c.value.length>1?c.value[c.value.length-2].name:c.value.length===1?"主菜单":"",L=(t,e)=>{B.value={x:e.clientX,y:e.clientY},M.value&&clearTimeout(M.value),M.value=setTimeout(()=>{w.value=t},1e3)},O=()=>{M.value&&(clearTimeout(M.value),M.value=null),w.value=null};return me(()=>{q()}),(t,e)=>{const r=_("PictureRounded"),o=_("el-icon"),s=_("el-input"),u=_("el-form-item"),h=_("el-option"),Q=_("el-select"),D=_("el-input-number"),ve=_("el-form"),R=_("el-button"),pe=_("el-dialog"),fe=ye("loading");return d(),I(S,null,[C("div",Ve,[v(k)==="main"?(d(),I("div",Ue,[C("div",{class:"column picture-rounded-container",onClick:e[0]||(e[0]=a=>v(z).push("/pigeonhole"))},[n(o,null,{default:i(()=>[n(r)]),_:1})]),(d(!0),I(S,null,F(X(),a=>(d(),I("div",{key:a.toolId,class:"column",onClick:V=>K(a),onMouseenter:V=>L(a,V),onMouseleave:O},[a.coverImageUrl&&a.coverImageUrl!==""?(d(),I("img",{key:0,src:a.coverImageUrl},null,8,Pe)):(d(),b(o,{key:1,class:"placeholder-icon"},{default:i(()=>[n(v(ee))]),_:1})),E(" "+$(a.name)+" ",1),n(o,{class:"setting-icon",onClick:te(V=>H(a),["stop"])},{default:i(()=>[n(v(le))]),_:2},1032,["onClick"])],40,xe))),128)),C("div",{class:"column",onClick:e[1]||(e[1]=a=>G(!1))},[n(o,null,{default:i(()=>[n(v(Z))]),_:1})])])):v(k)==="sub"?(d(),I("div",we,[C("div",Me,[n(o,{class:"back-icon",onClick:de},{default:i(()=>[n(v(he))]),_:1}),C("span",Ne,$(ce()),1),Y()?(d(),I("span",Te,"（返回："+$(Y())+"）",1)):U("",!0)]),C("div",$e,[(d(!0),I(S,null,F(X(),a=>(d(),I("div",{key:a.toolId,class:"column",onClick:V=>K(a),onMouseenter:V=>L(a,V),onMouseleave:O},[a.coverImageUrl&&a.coverImageUrl!==""?(d(),I("img",{key:0,src:a.coverImageUrl},null,8,Ae)):(d(),b(o,{key:1,class:"placeholder-icon"},{default:i(()=>[n(v(ee))]),_:1})),E(" "+$(a.name)+" ",1),n(o,{class:"setting-icon",onClick:te(V=>H(a),["stop"])},{default:i(()=>[n(v(le))]),_:2},1032,["onClick"])],40,Ee))),128)),C("div",{class:"column",onClick:e[2]||(e[2]=a=>G(!0,v(c)[v(c).length-1]))},[n(o,null,{default:i(()=>[n(v(Z))]),_:1})])])])):U("",!0)]),v(w)&&v(w).description?(d(),I("div",{key:0,class:"custom-tooltip",style:Ie(ie.value),onMouseenter:e[3]||(e[3]=a=>L(v(w),a)),onMouseleave:O},$(v(w).description),37)):U("",!0),n(pe,{modelValue:N.value,"onUpdate:modelValue":e[13]||(e[13]=a=>N.value=a),title:f.value?"编辑分类":y.value.isSubCategory?"添加子分类":"添加分类",width:"500px","before-close":A},{footer:i(()=>[C("div",De,[f.value?(d(),b(R,{key:0,type:"danger",onClick:e[12]||(e[12]=a=>ue()),loading:P.value},{default:i(()=>e[14]||(e[14]=[E("删除分类",-1)])),_:1,__:[14]},8,["loading"])):U("",!0),C("div",Se,[n(R,{onClick:A},{default:i(()=>e[15]||(e[15]=[E("取消",-1)])),_:1,__:[15]}),n(R,{type:"primary",onClick:se,loading:P.value},{default:i(()=>e[16]||(e[16]=[E("确定",-1)])),_:1,__:[16]},8,["loading"])])])]),default:i(()=>[_e((d(),b(ve,{ref_key:"formRef",ref:T,model:l.value,rules:ne,"label-width":"80px"},{default:i(()=>[f.value?(d(),b(u,{key:0,label:"分类ID"},{default:i(()=>[n(s,{modelValue:l.value.toolId,"onUpdate:modelValue":e[4]||(e[4]=a=>l.value.toolId=a),disabled:""},null,8,["modelValue"])]),_:1})):U("",!0),n(u,{label:"分类名称",prop:"toolName"},{default:i(()=>[n(s,{modelValue:l.value.toolName,"onUpdate:modelValue":e[5]||(e[5]=a=>l.value.toolName=a),placeholder:"请输入分类名称"},null,8,["modelValue"])]),_:1}),y.value.isSubCategory?U("",!0):(d(),b(u,{key:1,label:"父级ID"},{default:i(()=>[n(Q,{modelValue:l.value.parentId,"onUpdate:modelValue":e[6]||(e[6]=a=>l.value.parentId=a),placeholder:"请选择父级分类",clearable:"",onChange:re},{default:i(()=>[(d(!0),I(S,null,F(oe.value,a=>(d(),b(h,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})),n(u,{label:"分类路径",prop:"path"},{default:i(()=>[n(s,{modelValue:l.value.path,"onUpdate:modelValue":e[7]||(e[7]=a=>l.value.path=a),placeholder:"请输入分类路径"},null,8,["modelValue"])]),_:1}),y.value.isSubCategory&&l.value.parentId?(d(),b(u,{key:2,label:"父级ID"},{default:i(()=>[n(s,{modelValue:l.value.parentId,"onUpdate:modelValue":e[8]||(e[8]=a=>l.value.parentId=a),disabled:""},null,8,["modelValue"])]),_:1})):U("",!0),n(u,{label:"分类描述",prop:"description"},{default:i(()=>[n(s,{modelValue:l.value.description,"onUpdate:modelValue":e[9]||(e[9]=a=>l.value.description=a),type:"textarea",placeholder:"请输入分类描述（可选）"},null,8,["modelValue"])]),_:1}),n(u,{label:"封面地址",prop:"coverImageUrl"},{default:i(()=>[n(s,{modelValue:l.value.coverImageUrl,"onUpdate:modelValue":e[10]||(e[10]=a=>l.value.coverImageUrl=a),placeholder:"请输入封面图片地址"},null,8,["modelValue"])]),_:1}),n(u,{label:"优先级",prop:"sort"},{default:i(()=>[n(D,{modelValue:l.value.sort,"onUpdate:modelValue":e[11]||(e[11]=a=>l.value.sort=a),min:1,max:100,"controls-position":"right"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])),[[fe,P.value]])]),_:1},8,["modelValue","title"])],64)}}},Fe=ke(Be,[["__scopeId","data-v-34a3f914"]]);export{Fe as default};
